{% extends 'basetmp/base.html' %}
{% load custom_filters %}
{% load static %}
{% block content %}
{% csrf_token %}
{% load i18n %}

</div>


<!-- Текущая подписка -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="card-title mb-0">{{ current_sub }}</h3>
            <span class="badge bg-success py-2 px-3">{{ active_status }}</span>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="current-plan-info">
                    <div class="d-flex align-items-center mb-3">
                        <div class="plan-icon me-3">
                            <i class="ph ph-crown text-warning" style="font-size: 32px;"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">{{ plan }} "{{ professional }}"</h4>
                            <p class="text-muted mb-0">{{ tokens_prof }} {{ coins_per_month }}</p>
                        </div>
                    </div>

                    <div class="plan-details mt-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ start_date }}:</span>
                            <span class="fw-bold">{{ start_date_text }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ next_payment }}:</span>
                            <span class="fw-bold">{{ next_payment_text }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ price }}:</span>
                            <span class="fw-bold">{{ price_sum }} {{ сurrency }}/{{ month }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ payment }}:</span>
                            <span class="fw-bold">
                                <i class="ph ph-credit-card me-1"></i> •••• {{ last_card_nums }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="usage-stats p-3 rounded">
                    <h5 class="mb-3">{{ coins_using }}</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ coins_aval }}:</span>
                        <span class="fw-bold">{{ сurrent_expenses }} / {{ coins_available }}</span>
                    </div>

                    <div class="progress mb-4" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 49%" aria-valuenow="49" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>

                    <div class="token-usage-breakdown">
                        <h6 class="mb-2">{{ consumption }}:</h6>

                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ posts_gen }}:</span>
                            <span>{{ posts_gen_sum }} {{ coins }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ groups_an }}:</span>
                            <span>{{ groups_an_sum }} {{ coins }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ images_gen }}:</span>
                            <span>150 {{ coins }}</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#addCoinsModal">
                            <i class="ph ph-plus-circle me-2"></i> {{ add_coins }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-end">
            <button class="btn btn-outline-danger me-2">
                <i class="ph ph-x me-2"></i> {{ cancel_subs }}
            </button>
            <button class="btn btn-outline-primary">
                <i class="ph ph-pencil-simple me-2"></i> {{ change_plan }}
            </button>
        </div>
    </div>
</div>

<!-- Доступные тарифы с переключателем периода оплаты -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="card-title mb-0">{{ available_planes }}</h3>

            <!-- Переключатель периода оплаты -->
            <div class="billing-toggle">
                <span class="billing-period-text me-2">{{ monthly }}</span>
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" id="billingPeriodSwitch">
                        <label class="form-check-label" for="billingPeriodSwitch"></label>
                    </div>
                    <span class="billing-period-text ms-2">{{ annually }} <span class="badge bg-success ms-1">-20%</span></span>
                </div>
            </div>

            <div class="row">
            <!-- Тарифы -->
            {% for tariff in tariffs %}
            <div class="col-md-3 mb-4">
                <div class="card h-100 plan-card">
                    <div class="card-body d-flex flex-column">
                        <div class="plan-badge">
                            <span class="badge {{ tariff.style }}">{{ tariff.label }}</span>
                        </div>
                        <div class="plan-header mb-4">
                            <h4 class="plan-title">{{ tariff.tariff_name }}</h4>
                            <div class="tokens-amount mb-2">
                                <i class="ph ph-lightning me-1 text-warning"></i>
                                <span class="fw-bold">{{ tariff.coins_num }} {{ coins }}</span>
                            </div>
                            <div class="plan-price">
                                <span class="price" id="profi-price">{{ tariff.tariff_price }} {{ сurrency }}</span>
                                <span class="period">/{{ month }}</span>
                                </br>
                                <span class="savings-badge">{{ money_saving }} {{ tariff.saving_num }}%</span>
                            </div>
                            <p class="text-muted billing-period-text-monthly">{{ monthly_payment }}</p>
                            <p class="text-muted billing-period-text-yearly" style="display: none;">
                                {{ annual_payment }} ({{ discount }} {{ discount_percent }}%)
                            </p>
                        </div>
                        <div class="mt-auto">
                            <button class="btn btn-outline-primary w-100 update-btn"
                                    data-monthly="{{ tariff.tariff_price }}"
                                    data-yearly="{{ tariff.tariffliv_price | floatformat:0 | multiply:12 }}">
                                {{ upgrade_to }} {{ tariff.tariff_name }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Дополнительная информация о тарифах -->
        <div class="mt-4">
            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="ph ph-info me-3" style="font-size: 24px;"></i>
                <div>
                    <strong>{{ note }}:</strong>
                    {{ all_plans_include }} {{ number_of_requests }} {{ within_limits }}.
                    {{ paying_annually }} {{ discount_provided }} {{ discount_percent }}%.
                </div>
            </div>

            <div class="text-center mt-4">
                <p class="text-muted">{{ individual_rate }} {{ for_your_company }}?</p>
                <a href="#" class="btn btn-outline-primary">
                    <i class="ph ph-buildings me-2"></i> {{ corporate_offer }}
                </a>
            </div>
        </div>
    </div>
</div>


<!-- История платежей -->
<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title mb-4">{{ payment_history }}</h3>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>{{ date }}</th>
                        <th>{{ post_descr }}</th>
                        <th>{{ sum }}</th>
                        <th>{{ status }}</th>
                        <th>{{ check }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.payment_date }}</td>
                        <!-- Если нужно преобразовать "12.20.25" в "12.03.2023", используйте кастомный фильтр или измените payment_data -->
                        <td>{{ payment.title }}</td>
                        <td>{{ payment.sum }} ₽</td>
                        <td><span class="badge bg-success">{{ payment.Status }}</span></td>
                        <td><a href="#" class="text-decoration-none"><i class="ph ph-receipt me-1"></i> PDF</a></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">{{ no_payment_data }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if paginator and total_pages > 1 %}
        <div class="d-flex justify-content-center mt-3">
            <nav aria-label="История платежей">
                <ul class="pagination">
                    <li class="page-item {% if not paginator.has_previous %}disabled{% endif %}">
                        <a class="page-link" href="{% if paginator.has_previous %}?page={{ paginator.previous_page_number }}{% else %}#{% endif %}" {% if not paginator.has_previous %}tabindex="-1" aria-disabled="true"{% endif %}>Предыдущая</a>
                    </li>
                    {% for page_num in paginator.paginator.page_range %}
                        {% if page_num > current_page|add:-3 and page_num < current_page|add:3 %}
                        <li class="page-item {% if page_num == current_page %}active{% endif %}">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {% if not paginator.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{% if paginator.has_next %}?page={{ paginator.next_page_number }}{% else %}#{% endif %}" {% if not paginator.has_next %}tabindex="-1" aria-disabled="true"{% endif %}>Следующая</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>


<!-- Способы оплаты -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="card-title mb-0">{{ payment_methods }}</h3>
            <button class="btn btn-outline-primary btn-sm" id="addPaymentMethodBtn">
                <i class="ph ph-plus me-1"></i> {{ add_payment_method }}
            </button>
        </div>



        <div class="row">
            <!-- Карта 1 -->

            <div class="row">
                {% for card in cards %}
                <div class="col-md-6 mb-3">
                    <div class="card payment-method-card {% if card.is_main == 'True' %}active{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="payment-icon me-3">
                                        <i class="ph ph-credit-card" style="font-size: 24px;"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1">{{ card.card_type }} •••• {{ card.card_num|slice:"-4:" }}</h5>
                                        <p class="text-muted mb-0">{{ validity_period }}: {{ card.valid_period }}</p>
                                        <p class="text-muted mb-0">{{ card.cardholder_name }}</p>
                                    </div>
                                </div>
                                <div class="payment-actions">
                                    {% if card.is_main == 'True' %}
                                    <span class="badge bg-primary me-2">{{ main_text }}</span>
                                    {% endif %}
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm btn-light" type="button" id="dropdownMenuButton{{ card.card_id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ph ph-dots-three-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ card.card_id }}">
                                            <li>
                                                <a class="dropdown-item edit-card-btn"
                                                   href="#"
                                                   data-card-id="{{ card.card_id }}"
                                                   data-card-type="{{ card.card_type }}"
                                                   data-card-num="{{ card.card_num }}"
                                                   data-valid-period="{{ card.valid_period }}"
                                                   data-cardholder-name="{{ card.cardholder_name }}"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#addPaymentMethodModal">
                                                    <i class="ph ph-pencil me-2"></i>{{ edit_button }}
                                                </a>
                                            </li>
                                            <form method="POST" action="{% url 'delete_card' card.card_id %}">
                                                {% csrf_token %}
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="ph ph-trash me-2"></i>
                                                        {{ delete_button }}
                                                    </button>
                                                </form>
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <p class="text-center text-muted">{{ no_saved_cards }}</p>
                </div>
                {% endfor %}
            </div>

        </div>
    </div>
</div>

<!-- Часто задаваемые вопросы -->
<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title mb-4">{{ faq }}</h3>

        <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        {{ how_coins_work }}
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {{ internal_currency }} {{ project_name }}, {{ which_is_used }} {{ various_functions }}. {{ plan_includes }}
                        {{ certain_number}}. {{ сoins_spent_on }} {{ generation_of_posts }}, {{ group_analysis }},
                        {{ image_creation }} {{ and_other_functions }}. {{ have_enough_coins }}, {{ purchase_additional }}.
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                        {{ how_can_change }}
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {{ you_can_change }}
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingThree">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                        {{ howto_cancel_subscription }}
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {{ how_to_cancel }}
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingFour">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                        {{ roll_over }}
                    </button>
                </h2>
                <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {{ unused_coins }}
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingFive">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                        {{ invoice_for_accounting }}
                    </button>
                </h2>
                <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {{ accounting }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Поддержка -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h3 class="card-title mb-4">{{ need_help }}</h3>
                <p class="mb-4">{{ support_team }}</p>
                <div class="d-grid gap-2 d-md-flex">
                    <a href="#" class="btn btn-primary">
                        <i class="ph ph-chats me-2"></i> {{ write_to_support }}
                    </a>
                    <a href="#" class="btn btn-outline-secondary">
                        <i class="ph ph-book-open me-2"></i> {{ help_center }}
                    </a>
                </div>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-center">
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>

<!-- Модальное окно добавления способа оплаты -->
<div class="modal fade" id="addPaymentMethodModal" tabindex="-1" aria-labelledby="addPaymentMethodModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPaymentMethodModalLabel">{{ payment_method }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentMethodForm" method="POST" action="{% url 'add_payment_method' %}"
                    data-add-url="{% url 'add_payment_method' %}"
                    data-edit-url="{% url 'edit_payment_method' %}">
                    {% csrf_token %}
                    <input type="hidden" id="cardId" name="cardId">
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">{{ card_num }}</label>
                        <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" required>
                        <div class="invalid-feedback">{{ enter_card_number }}.</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="expiryDate" class="form-label">{{ validity_period }}</label>
                            <input type="text" class="form-control" id="expiryDate" name="expiryDate" placeholder="ММ/ГГ" required>
                            <div class="invalid-feedback">{{ enter_card_period }}.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" name="cvv" placeholder="***" required>
                            <div class="invalid-feedback">{{ enter_card_cvv }}.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="cardholderName" class="form-label">{{ cardholder_name }}</label>
                        <input type="text" class="form-control" id="cardholderName" name="cardholderName" placeholder="IVAN IVANOV" required>
                        <div class="invalid-feedback">{{ enter_cardholder_name }}.</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="makeDefaultCard" name="makeDefaultCard">
                        <label class="form-check-label" for="makeDefaultCard">
                            {{ make_main_payment_method }}
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ cancel }}</button>
                <button type="button" class="btn btn-primary" id="savePaymentMethodBtn">{{ save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления коинов -->
<div class="modal fade" id="addCoinsModal" tabindex="-1" aria-labelledby="addCoinsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCoinsModalLabel">{% trans "Add Coins" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCoinsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="coinAmount" class="form-label">{{ group_name }}</label>
                        <input type="number" class="form-control" id="coinAmount" placeholder="{% trans 'Enter number of coins' %}" required min="1">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "Add Coins" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно отмены подписки -->
<div class="modal fade" id="cancelSubscriptionModal" tabindex="-1" aria-labelledby="cancelSubscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelSubscriptionModalLabel">{{ cancel_subscription }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="ph ph-warning-circle text-warning" style="font-size: 64px;"></i>
                    <h4 class="mt-3">{{ cancel_subscription_confirm }}</h4>
                </div>

                <p>{{ cancel_subscription_options }}:</p>
                <ul>
                    <li>{{ will_be_active_until }} {{ subscr_end_date }}</li>
                    <li>{{ automatic_renewal_disabled }}</li>
                    <li>{{ use_all_functions }} {{ before_expiration }}</li>
                    <li>{{ renew_subscription }}</li>
                </ul>

                <div class="form-group mt-4">
                    <label for="cancellationReason" class="form-label">{{ reason_for_cancel }}</label>
                    <select class="form-select" id="cancellationReason">
                        <option value="" selected>{{ select_reason }}...</option>
                        <option value="too_expensive">{{ too_expensive }}</option>
                        <option value="not_using">{{ not_use_service }}</option>
                        <option value="missing_features">{{ missing_features }}</option>
                        <option value="found_alternative">{{ found_alternative }}</option>
                        <option value="other">{{ other }}</option>
                    </select>
                </div>

                <div class="form-group mt-3" id="otherReasonContainer" style="display: none;">
                    <label for="otherReason" class="form-label">{{ write_reason }}</label>
                    <textarea class="form-control" id="otherReason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ cancel }}</button>
                <button type="button" class="btn btn-danger" id="confirmCancelSubscriptionBtn">{{ сonfirm_unsubscription }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Контейнер для уведомлений -->
<div id="alertsContainer"></div>

<!-- JavaScript для работы с мобильным меню -->
<script src = "{% static 'js/mobile_menu.js' %}"></script>

<!-- Переводы для метода оплаты -->
<script>
    window.translations = {
        error_processing_form: "{{ error_processing_form }}",
        unknown_error: "{{ unknown_error }}",
        error_sending_form: "{{ error_sending_form }}",
        adding_payment_method: "{{ payment_method }}",
        save: "{{ save }}",
        edit_payment_method: "{{ payment_method }}",
        error: "{{ error }}",
        succpay: "{{ succ_pay }}",
    };
</script>

<!-- JavaScript для редактирования карты -->
<script src = "{% static 'js/subscription/edit_card.js' %}"></script>

<!-- JavaScript для обработки удаления -->
<script src = "{% static 'js/subscription/delete_card.js' %}"></script>

<!-- JavaScript для обработки метода оплаты -->
<script src = "{% static 'js/subscription/add_payment_method.js' %}"></script>

<!-- JavaScript для обработки формы -->
<script>
document.getElementById('addCoinsForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const coinAmount = document.getElementById('coinAmount').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Вывод в консоль (заглушка)
    console.log('Количество коинов:', coinAmount);

    try {
        const response = await fetch('{% url "add_coins" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                coins: parseInt(coinAmount)
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Успешная обработка
            console.log('Успех:', data);
            // Закрываем модалку
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCoinsModal'));
            modal.hide();
            // Перезагружаем страницу
            window.location.reload();
        } else {
            console.error('Ошибка:', data);
        }
    } catch (error) {
        console.error('Ошибка при отправке:', error);
    }
});
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
// Переменные для элементов UI
const toggleButton = document.querySelector('.toggle-sidebar');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.overlay');
const addPaymentMethodBtn = document.getElementById('addPaymentMethodBtn');
const cancelSubscriptionBtn = document.querySelector('.btn-outline-danger');
const cancellationReason = document.getElementById('cancellationReason');
const otherReasonContainer = document.getElementById('otherReasonContainer');
const confirmCancelSubscriptionBtn = document.getElementById('confirmCancelSubscriptionBtn');
const savePaymentMethodBtn = document.getElementById('savePaymentMethodBtn');
const billingSwitch = document.getElementById('billingPeriodSwitch');

// Обработчик для мобильного меню
if (toggleButton) {
    toggleButton.addEventListener('click', function() {
        sidebar.classList.toggle('show');
        if (sidebar.classList.contains('show')) {
            overlay.style.display = 'block';
        } else {
            overlay.style.display = 'none';
        }
    });
}

if (overlay) {
    overlay.addEventListener('click', function() {
        sidebar.classList.remove('show');
        overlay.style.display = 'none';
    });
}

// Инициализация модальных окон
if (addPaymentMethodBtn) {
    addPaymentMethodBtn.addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('addPaymentMethodModal'));
        modal.show();
    });
}

// Обработчик для кнопки отмены подписки
if (cancelSubscriptionBtn) {
    // Сохраняем оригинальный HTML кнопки
    const originalButtonHTML = cancelSubscriptionBtn.innerHTML;
    const originalButtonClass = 'btn-outline-danger';
    const renewButtonClass = 'btn-outline-success';

    // Флаг для отслеживания состояния подписки
    let isSubscriptionCancelled = false;

    // Функция для обработки клика на кнопку отмены/возобновления
    function handleSubscriptionButtonClick() {
        if (!isSubscriptionCancelled) {
            // Если подписка активна - показываем модальное окно отмены
            const modal = new bootstrap.Modal(document.getElementById('cancelSubscriptionModal'));
            modal.show();
        } else {
            // Если подписка уже отменена - возобновляем её

            // Находим бейдж статуса подписки
            const statusBadge = document.querySelector('.card-body .badge.bg-warning');
            if (statusBadge) {
                statusBadge.classList.remove('bg-warning');
                statusBadge.classList.add('bg-success');
                statusBadge.textContent = {{ active }};
            }

            // Возвращаем исходный вид кнопки
            cancelSubscriptionBtn.classList.remove(renewButtonClass);
            cancelSubscriptionBtn.classList.add(originalButtonClass);
            cancelSubscriptionBtn.innerHTML = originalButtonHTML;

            // Обновляем флаг состояния
            isSubscriptionCancelled = false;

            // Показываем уведомление о возобновлении подписки
            showAlert('{{ successfully_renewed }}', 'success');
        }
    }

    // Добавляем обработчик события клика
    cancelSubscriptionBtn.addEventListener('click', handleSubscriptionButtonClick);

    // Обработчик для подтверждения отмены подписки
    if (confirmCancelSubscriptionBtn) {
        confirmCancelSubscriptionBtn.addEventListener('click', function() {
            // Получаем выбранную причину отмены
            const reason = cancellationReason ? cancellationReason.value : '';
            let reasonText = '';

            if (reason === 'too_expensive') {
                reasonText = '{{ too_expensive }}';
            } else if (reason === 'not_using') {
                reasonText = '{{ not_use_service }}';
            } else if (reason === 'missing_features') {
                reasonText = '{{ missing_features }}';
            } else if (reason === 'found_alternative') {
                reasonText = '{{ found_alternative }}';
            } else if (reason === 'other') {
                reasonText = document.getElementById('otherReason').value || 'Другое';
            }

            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelSubscriptionModal'));
            modal.hide();

            // Находим бейдж статуса подписки
            const statusBadge = document.querySelector('.card-body .badge.bg-success');
            if (statusBadge) {
                // Меняем цвет и текст бейджа
                statusBadge.classList.remove('bg-success');
                statusBadge.classList.add('bg-warning');
                statusBadge.textContent = '{{ will_cancelled }} 15.04.2023';
            }

            // Меняем внешний вид кнопки
            cancelSubscriptionBtn.classList.remove(originalButtonClass);
            cancelSubscriptionBtn.classList.add(renewButtonClass);
            cancelSubscriptionBtn.innerHTML = '<i class="ph ph-arrows-clockwise me-2"></i> Возобновить подписку';

            // Обновляем флаг состояния
            isSubscriptionCancelled = true;

            // Показать уведомление
            showAlert('{{ will_be_cancelled }}. {{ reason }}: ' + reasonText, 'info');
        });
    }
}

// Показ поля для другой причины отмены
if (cancellationReason && otherReasonContainer) {
    cancellationReason.addEventListener('change', function() {
        if (this.value === 'other') {
            otherReasonContainer.style.display = 'block';
        } else {
            otherReasonContainer.style.display = 'none';
        }
    });
}

// Обработчик для переключателя периода оплаты
if (billingSwitch) {
    billingSwitch.addEventListener('change', function() {
        const isYearly = this.checked;

        // Обновляем цены в зависимости от выбранного периода
        updatePricesBasedOnPeriod(isYearly);

        // Показываем/скрываем соответствующие тексты периода
        document.querySelectorAll('.billing-period-text-monthly').forEach(el => {
            el.style.display = isYearly ? 'none' : 'block';
        });

        document.querySelectorAll('.billing-period-text-yearly').forEach(el => {
            el.style.display = isYearly ? 'block' : 'none';
        });
    });
}

// Обработчик для кнопок "Обновить"
document.querySelectorAll('.update-btn').forEach(button => {
    button.addEventListener('click', function() {
        const isYearly = billingSwitch ? billingSwitch.checked : false;
        const planName = this.textContent.replace('{{ upgrade_to }} ', '').replace(' ({{ annual_plan }})', '');
        const price = isYearly ? this.getAttribute('data-yearly') : this.getAttribute('data-monthly');
        const periodText = isYearly ? 'год' : 'месяц';
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(price);

        // Показываем модальное окно подтверждения
        showPlanConfirmation(planName, formattedPrice, periodText);
    });
});
});

// Функция для обновления цен в зависимости от выбранного периода
function updatePricesBasedOnPeriod(isYearly) {
    // Получаем элементы цен
    const profiPrice = document.getElementById('profi-price');
    const pro50Price = document.getElementById('pro50-price');
    const pro100Price = document.getElementById('pro100-price');
    const pro200Price = document.getElementById('pro200-price');

    if (!profiPrice || !pro50Price || !pro100Price || !pro200Price) {
        return; // Если элементы не найдены, выходим из функции
    }

    // Массив элементов цен для анимации
    const priceElements = [profiPrice, pro50Price, pro100Price, pro200Price];

    // Добавляем класс анимации
    priceElements.forEach(el => {
        el.classList.add('price-changed');

        // Удаляем класс анимации после завершения
        setTimeout(() => {
            el.classList.remove('price-changed');
        }, 500);
    });

    if (isYearly) {
        // Применяем скидку 20% для годовой оплаты
        profiPrice.textContent = '792 ₽';
        pro50Price.textContent = '1,832 ₽';
        pro100Price.textContent = '3,480 ₽';
        pro200Price.textContent = '6,392 ₽';

        // Обновляем перечеркнутые цены для годовой подписки
        const originalPrices = document.querySelectorAll('.original-price');
        if (originalPrices.length >= 3) {
            originalPrices[0].textContent = '1,980 ₽';
            originalPrices[1].textContent = '3,960 ₽';
            originalPrices[2].textContent = '7,920 ₽';
        }
    } else {
        // Возвращаем обычные цены для месячной оплаты
        profiPrice.textContent = '990 ₽';
        pro50Price.textContent = '2,290 ₽';
        pro100Price.textContent = '4,350 ₽';
        pro200Price.textContent = '7,990 ₽';

        // Возвращаем перечеркнутые цены для месячной подписки
        const originalPrices = document.querySelectorAll('.original-price');
        if (originalPrices.length >= 3) {
            originalPrices[0].textContent = '2,475 ₽';
            originalPrices[1].textContent = '4,950 ₽';
            originalPrices[2].textContent = '9,900 ₽';
        }
    }

    // Обновляем текст на кнопках
    updateButtonText(isYearly);
}

// Функция для обновления текста на кнопках
function updateButtonText(isYearly) {
    document.querySelectorAll('.update-btn').forEach(button => {
        const planName = button.textContent.replace('{{ upgrade_to }} ', '').replace(' ({{ annual_plan }})', '');
        if (isYearly) {
            button.textContent = `{{ upgrade_to }} ${planName} ({{ annual_plan }})`;
        } else {
            button.textContent = `{{ upgrade_to }} ${planName}`;
        }
    });
}

// Добавляем модальное окно для подтверждения обновления тарифа
function showPlanConfirmation(planName, price, period) {
    // Создаем HTML для модального окна
    const modalHTML = `
    <div class="modal fade" id="planConfirmationModal" tabindex="-1" aria-labelledby="planConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planConfirmationModalLabel">Подтверждение обновления тарифа</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="ph ph-check-circle text-success" style="font-size: 64px;"></i>
                        <h4 class="mt-3">Вы выбрали тариф "${planName}"</h4>
                    </div>

                    <div class="plan-details p-3 rounded" style="background-color: #6B6F73;">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Стоимость:</span>
                            <span class="fw-bold">${price} ₽/${period}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Период оплаты:</span>
                            <span class="fw-bold">${period === 'месяц' ? 'Ежемесячно' : 'Ежегодно'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Дата следующего списания:</span>
                            <span class="fw-bold">${getNextBillingDate(period)}</span>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <small>Нажимая "Подтвердить", вы соглашаетесь с условиями использования сервиса и подтверждаете, что с вашей карты будет списана указанная сумма.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                      <button type="button" class="btn btn-primary" id="confirmPlanUpdateBtn">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>
    `;

    // Удаляем существующее модальное окно, если оно есть
    const existingModal = document.getElementById('planConfirmationModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Добавляем модальное окно в DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Инициализируем модальное окно
    const modal = new bootstrap.Modal(document.getElementById('planConfirmationModal'));
    modal.show();

    // Обработчик для кнопки подтверждения
    document.getElementById('confirmPlanUpdateBtn').addEventListener('click', function() {
        // Здесь будет логика обновления тарифа
        modal.hide();

        // Удаляем модальное окно из DOM после закрытия
        document.getElementById('planConfirmationModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });

        // Показываем уведомление об успешном обновлении
        showAlert(`Тариф успешно обновлен до "${planName}"`, 'success');
    });

    // Удаляем модальное окно из DOM после закрытия
    document.getElementById('planConfirmationModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Функция для получения даты следующего списания
function getNextBillingDate(period) {
    const today = new Date();
    let nextDate = new Date(today);

    if (period === 'месяц') {
        nextDate.setMonth(today.getMonth() + 1);
    } else {
        nextDate.setFullYear(today.getFullYear() + 1);
    }

    return nextDate.toLocaleDateString('ru-RU');
}

// Функция для показа уведомлений
function showAlert(message, type = 'info') {
    const alertsContainer = document.getElementById('alertsContainer');
    if (!alertsContainer) return;

    const alertId = Date.now();

    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show`;
    alertElement.role = 'alert';
    alertElement.id = `alert-${alertId}`;

    alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    alertsContainer.appendChild(alertElement);

    // Автоматическое скрытие уведомления через 5 секунд
    setTimeout(() => {
        const alert = document.getElementById(`alert-${alertId}`);
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}






    </script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Phosphor Icons JavaScript -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

{% endblock %}